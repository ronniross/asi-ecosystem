name: Track All Repository Clones

on:
  schedule:
    - cron: '33 3 * * *'  # 3:33 AM UTC daily
  workflow_dispatch:      # Allow manual trigger
  push:
    paths:
      - '.github/workflows/track-clones.yml'
      - 'README.md'

jobs:
  track-clones:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize tracking system
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create data directory
          mkdir -p analytics
          
          # Set GMT-3 timezone
          export TZ='America/Sao_Paulo'
          CURRENT_TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S GMT-3')
          
          # Check if this is the first run
          if [ ! -f analytics/tracking-started.txt ]; then
            echo "First run detected - initializing tracking system"
            echo "$CURRENT_TIMESTAMP" > analytics/tracking-started.txt
            echo "Tracking started: $CURRENT_TIMESTAMP"
            echo "---"
          else
            TRACKING_STARTED=$(cat analytics/tracking-started.txt)
            echo "Tracking system started on: $TRACKING_STARTED"
            echo "Current run: $CURRENT_TIMESTAMP"
            echo "---"
          fi

      - name: Extract repositories from README
        run: |
          # Extract repository names from README.md table links
          grep -oP 'https://github\.com/[^)]+' README.md | \
            sed 's|https://github.com/||' | \
            sort -u > extracted_repos.txt
          
          echo "Extracted repositories:"
          cat extracted_repos.txt
          echo "---"

      - name: Fetch and record clone data for all repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export TZ='America/Sao_Paulo'
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
          READABLE_TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S GMT-3')
          
          echo "Processing repositories..."
          echo ""
          
          # Initialize aggregate data
          AGGREGATE_TOTAL=0
          AGGREGATE_UNIQUE=0
          
          # Process each repository
          while IFS= read -r REPO_FULL_NAME || [ -n "$REPO_FULL_NAME" ]; do
            # Skip empty lines
            [[ -z "$REPO_FULL_NAME" ]] && continue
            
            REPO_OWNER="${REPO_FULL_NAME%/*}"
            REPO_NAME="${REPO_FULL_NAME#*/}"
            
            echo "Fetching data for: $REPO_FULL_NAME"
            
            # Create repository-specific directory
            mkdir -p "analytics/$REPO_NAME"
            
            # Fetch current clone statistics
            RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO_FULL_NAME/traffic/clones")
            
            # Extract current values
            CURRENT_TOTAL=$(echo "$RESPONSE" | grep -o '"count":[0-9]*' | head -1 | cut -d':' -f2)
            CURRENT_UNIQUE=$(echo "$RESPONSE" | grep -o '"uniques":[0-9]*' | head -1 | cut -d':' -f2)
            
            # Handle case where API returns no data
            if [ -z "$CURRENT_TOTAL" ]; then
              CURRENT_TOTAL=0
            fi
            if [ -z "$CURRENT_UNIQUE" ]; then
              CURRENT_UNIQUE=0
            fi
            
            # Read baseline data if exists
            BASELINE_FILE="analytics/$REPO_NAME/baseline.json"
            if [ -f "$BASELINE_FILE" ]; then
              BASELINE_TOTAL=$(grep -o '"initial_total_clones": [0-9]*' "$BASELINE_FILE" | grep -o '[0-9]*')
              BASELINE_UNIQUE=$(grep -o '"initial_unique_clones": [0-9]*' "$BASELINE_FILE" | grep -o '[0-9]*')
              TRACKING_STARTED=$(grep -o '"tracking_started": "[^"]*"' "$BASELINE_FILE" | cut -d'"' -f4)
            else
              # Create baseline on first run for this repo
              BASELINE_TOTAL=$CURRENT_TOTAL
              BASELINE_UNIQUE=$CURRENT_UNIQUE
              TRACKING_STARTED=$(cat analytics/tracking-started.txt)
              
              echo "{\"tracking_started\": \"$TRACKING_STARTED\", \"initial_total_clones\": $BASELINE_TOTAL, \"initial_unique_clones\": $BASELINE_UNIQUE}" > "$BASELINE_FILE"
            fi
            
            # Calculate totals including baseline
            TOTAL_WITH_BASELINE=$((CURRENT_TOTAL + BASELINE_TOTAL))
            UNIQUE_WITH_BASELINE=$((CURRENT_UNIQUE + BASELINE_UNIQUE))
            
            # Add to aggregate
            AGGREGATE_TOTAL=$((AGGREGATE_TOTAL + TOTAL_WITH_BASELINE))
            AGGREGATE_UNIQUE=$((AGGREGATE_UNIQUE + UNIQUE_WITH_BASELINE))
            
            # Create enhanced data file
            cat > "analytics/$REPO_NAME/clones_$TIMESTAMP.json" << 'DATAEOF'
{
  "repository": "REPO_PLACEHOLDER",
  "timestamp": "TIMESTAMP_PLACEHOLDER",
  "tracking_started": "TRACKING_PLACEHOLDER",
  "current_period": {
    "total_clones": CURRENT_TOTAL_PLACEHOLDER,
    "unique_clones": CURRENT_UNIQUE_PLACEHOLDER,
    "note": "Last 14 days as per GitHub API"
  },
  "baseline": {
    "total_clones": BASELINE_TOTAL_PLACEHOLDER,
    "unique_clones": BASELINE_UNIQUE_PLACEHOLDER
  },
  "cumulative": {
    "total_clones": TOTAL_PLACEHOLDER,
    "unique_clones": UNIQUE_PLACEHOLDER,
    "note": "Current period + baseline from tracking start"
  },
  "raw_api_response": RESPONSE_PLACEHOLDER
}
DATAEOF
            
            # Replace placeholders
            sed -i "s|REPO_PLACEHOLDER|$REPO_FULL_NAME|g" "analytics/$REPO_NAME/clones_$TIMESTAMP.json"
            sed -i "s|TIMESTAMP_PLACEHOLDER|$READABLE_TIMESTAMP|g" "analytics/$REPO_NAME/clones_$TIMESTAMP.json"
            sed -i "s|TRACKING_PLACEHOLDER|$TRACKING_STARTED|g" "analytics/$REPO_NAME/clones_$TIMESTAMP.json"
            sed -i "s|CURRENT_TOTAL_PLACEHOLDER|$CURRENT_TOTAL|g" "analytics/$REPO_NAME/clones_$TIMESTAMP.json"
            sed -i "s|CURRENT_UNIQUE_PLACEHOLDER|$CURRENT_UNIQUE|g" "analytics/$REPO_NAME/clones_$TIMESTAMP.json"
            sed -i "s|BASELINE_TOTAL_PLACEHOLDER|$BASELINE_TOTAL|g" "analytics/$REPO_NAME/clones_$TIMESTAMP.json"
            sed -i "s|BASELINE_UNIQUE_PLACEHOLDER|$BASELINE_UNIQUE|g" "analytics/$REPO_NAME/clones_$TIMESTAMP.json"
            sed -i "s|TOTAL_PLACEHOLDER|$TOTAL_WITH_BASELINE|g" "analytics/$REPO_NAME/clones_$TIMESTAMP.json"
            sed -i "s|UNIQUE_PLACEHOLDER|$UNIQUE_WITH_BASELINE|g" "analytics/$REPO_NAME/clones_$TIMESTAMP.json"
            sed -i "s|RESPONSE_PLACEHOLDER|$RESPONSE|g" "analytics/$REPO_NAME/clones_$TIMESTAMP.json"
            
            echo "  Current: $CURRENT_TOTAL total, $CURRENT_UNIQUE unique"
            echo "  Cumulative: $TOTAL_WITH_BASELINE total, $UNIQUE_WITH_BASELINE unique"
            echo ""
            
          done < extracted_repos.txt
          
          # Create aggregate summary
          cat > "analytics/aggregate_$TIMESTAMP.json" << 'AGGEOF'
{
  "timestamp": "TIMESTAMP_PLACEHOLDER",
  "ecosystem_totals": {
    "total_clones": TOTAL_PLACEHOLDER,
    "unique_clones": UNIQUE_PLACEHOLDER,
    "note": "Sum of all repositories cumulative totals"
  }
}
AGGEOF
          
          # Replace placeholders
          sed -i "s|TIMESTAMP_PLACEHOLDER|$READABLE_TIMESTAMP|g" "analytics/aggregate_$TIMESTAMP.json"
          sed -i "s|TOTAL_PLACEHOLDER|$AGGREGATE_TOTAL|g" "analytics/aggregate_$TIMESTAMP.json"
          sed -i "s|UNIQUE_PLACEHOLDER|$AGGREGATE_UNIQUE|g" "analytics/aggregate_$TIMESTAMP.json"
          
          echo "====================================="
          echo "Ecosystem-wide Statistics"
          echo "Recorded at: $READABLE_TIMESTAMP"
          echo ""
          echo "Total clones across all repositories: $AGGREGATE_TOTAL"
          echo "Total unique clones across all repositories: $AGGREGATE_UNIQUE"
          echo ""
          echo "Data saved to: analytics/aggregate_$TIMESTAMP.json"

      - name: Commit and push data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add analytics/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            export TZ='America/Sao_Paulo'
            COMMIT_TIME=$(date '+%Y-%m-%d %H:%M:%S GMT-3')
            git commit -m "Update clone statistics - $COMMIT_TIME"
            git push
          fi
