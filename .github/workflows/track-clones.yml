name: Track All Repository Clones

on:
  schedule:
    - cron: '33 3 * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/track-clones.yml'
      - 'README.md'

jobs:
  track-clones:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract repositories from README
        run: |
          grep -oP 'https://github\.com/\K[\w-]+/[\w.-]+' README.md | sort -u > extracted_repos.txt
          echo "Extracted repositories:"
          cat extracted_repos.txt
          echo "---"

      - name: Fetch and record clone data
        env:
          TRAFFIC_TOKEN: ${{ secrets.TRAFFIC_TOKEN }}
        run: |
          TIMESTAMP=$(TZ='Etc/GMT+3' date +%Y-%m-%d_%H-%M-%S)
          READABLE_TIMESTAMP=$(TZ='Etc/GMT+3' date '+%Y-%m-%d %H:%M:%S GMT-3')
          
          # CHECKPOINT - December 6th baseline (ecosystem-wide totals)
          CHECKPOINT_DATE="2025-12-06 00:55:13 GMT-3"
          CHECKPOINT_TOTAL=1254
          CHECKPOINT_UNIQUE=966
          
          echo "Processing repositories..."
          echo "Checkpoint: $CHECKPOINT_DATE"
          echo ""
          
          CURRENT_ECOSYSTEM_TOTAL=0
          CURRENT_ECOSYSTEM_UNIQUE=0
          
          mkdir -p analytics
          
          while IFS= read -r REPO_FULL_NAME || [ -n "$REPO_FULL_NAME" ]; do
            [[ -z "$REPO_FULL_NAME" ]] && continue
            
            REPO_FULL_NAME=$(echo "$REPO_FULL_NAME" | sed 's/[./]*$//')
            REPO_NAME="${REPO_FULL_NAME#*/}"
            
            echo "Fetching: $REPO_FULL_NAME"
            
            mkdir -p "analytics/$REPO_NAME"
            
            # Fetch current 14-day window from GitHub API
            HTTP_RESPONSE=$(curl -s -w "%{http_code}" \
              -H "Authorization: token $TRAFFIC_TOKEN" \
              "https://api.github.com/repos/$REPO_FULL_NAME/traffic/clones")
            
            HTTP_BODY=${HTTP_RESPONSE:0:${#HTTP_RESPONSE}-3}
            HTTP_STATUS=${HTTP_RESPONSE:${#HTTP_RESPONSE}-3}
            
            if [ "$HTTP_STATUS" != "200" ]; then
              echo "::error::Failed to fetch $REPO_FULL_NAME. Status: $HTTP_STATUS"
              continue
            fi
            
            TOTAL=$(echo "$HTTP_BODY" | jq '.count // 0')
            UNIQUE=$(echo "$HTTP_BODY" | jq '.uniques // 0')
            
            echo "  API: $TOTAL total, $UNIQUE unique (14-day window)"
            
            # Save daily snapshot
            jq -n \
              --arg repo "$REPO_FULL_NAME" \
              --arg ts "$READABLE_TIMESTAMP" \
              --argjson total "$TOTAL" \
              --argjson unique "$UNIQUE" \
              '{repository: $repo, timestamp: $ts, total_clones: $total, unique_clones: $unique}' \
              > "analytics/$REPO_NAME/clones_$TIMESTAMP.json"
            
            CURRENT_ECOSYSTEM_TOTAL=$((CURRENT_ECOSYSTEM_TOTAL + TOTAL))
            CURRENT_ECOSYSTEM_UNIQUE=$((CURRENT_ECOSYSTEM_UNIQUE + UNIQUE))
            echo ""
            
          done < extracted_repos.txt
          
          # Calculate growth since checkpoint
          GROWTH_TOTAL=$((CURRENT_ECOSYSTEM_TOTAL - CHECKPOINT_TOTAL))
          GROWTH_UNIQUE=$((CURRENT_ECOSYSTEM_UNIQUE - CHECKPOINT_UNIQUE))
          
          # Save ecosystem summary
          jq -n \
            --arg ts "$READABLE_TIMESTAMP" \
            --arg checkpoint_date "$CHECKPOINT_DATE" \
            --argjson checkpoint_total "$CHECKPOINT_TOTAL" \
            --argjson checkpoint_unique "$CHECKPOINT_UNIQUE" \
            --argjson current_total "$CURRENT_ECOSYSTEM_TOTAL" \
            --argjson current_unique "$CURRENT_ECOSYSTEM_UNIQUE" \
            --argjson growth_total "$GROWTH_TOTAL" \
            --argjson growth_unique "$GROWTH_UNIQUE" \
            '{
              timestamp: $ts,
              checkpoint: {
                date: $checkpoint_date,
                total_clones: $checkpoint_total,
                unique_clones: $checkpoint_unique
              },
              current: {
                total_clones: $current_total,
                unique_clones: $current_unique
              },
              growth_since_checkpoint: {
                total_clones: $growth_total,
                unique_clones: $growth_unique
              }
            }' > "analytics/ecosystem_$TIMESTAMP.json"
          
          echo "====================================="
          echo "Ecosystem Statistics"
          echo "Timestamp: $READABLE_TIMESTAMP"
          echo "Current (14-day window): $CURRENT_ECOSYSTEM_TOTAL total, $CURRENT_ECOSYSTEM_UNIQUE unique"
          echo "Checkpoint: $CHECKPOINT_TOTAL total, $CHECKPOINT_UNIQUE unique"
          echo "Growth: +$GROWTH_TOTAL total, +$GROWTH_UNIQUE unique"
          echo "====================================="

      - name: Commit and push data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add analytics/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            COMMIT_TIME=$(TZ='Etc/GMT+3' date '+%Y-%m-%d %H:%M:%S GMT-3')
            git commit -m "ðŸ“Š Clone stats: $COMMIT_TIME"
            git push
          fi
